# Makefile.in -- Makefile for lmdbg
# Copyright 2003 Aleksey Cheusov <vle@gmx.net>
# 
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 1, or (at your option) any
# later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 675 Mass Ave, Cambridge, MA 02139, USA.
# 

LMDBG_VERSION=@LMDBG_VERSION@

srcdir=		@srcdir@
VPATH=		@srcdir@
prefix=		@prefix@
exec_prefix=	@exec_prefix@
man1_prefix=	@mandir@/man1
man8_prefix=	@mandir@/man8
bindir=         @bindir@
libdir=         @libdir@
libexecdir=     @libexecdir@
sbindir=        @sbindir@
includedir=     @includedir@
datadir=        @datadir@
sysconfdir=     @sysconfdir@

DESTDIR=
SHELL=		/bin/sh
EXEEXT=         @EXEEXT@

CC=		@CC@
CPP=		@CPP@
AR=             @AR@
INSTALL=	@INSTALL@
INSTALL_PROGRAM=@INSTALL_PROGRAM@
INSTALL_SCRIPT= @INSTALL_SCRIPT@
INSTALL_DATA=	@INSTALL_DATA@

CFLAGS=		@CFLAGS@ -DLMDBG_VERSION=\"$(LMDBG_VERSION)\"
LDFLAGS=        @LDFLAGS@
LDLIBS=		@LIBS@

@SET_MAKE@

ALLCFLAGS=$(CFLAGS) -DLMDBG_VERSION=\"$(LMDBG_VERSION)\" -I.
ALLLDFLAGS=$(LDFLAGS) $(LDLIBS)

SRCS = Makefile TODO README NEWS COPYING lmdbg-run.in \
	lmdbg.c

.PHONY: all
all : liblmdbg.la

.c.o:
	libtool --tag=CC --mode=compile $(CC) -o $@ -c -D_GNU_SOURCE $(ALLCFLAGS) \
	   -g -O0 $<

liblmdbg.la : lmdbg.o
	libtool --tag=CC --mode=link $(CC) -o $@ -rpath $(libdir) \
	   -version-info 0:0 -g lmdbg.lo $(ALLLDFLAGS)

.PHONY: install
install : all
	$(INSTALL) -d $(DESTDIR)$(libdir)
	$(INSTALL) -d $(DESTDIR)$(bindir)
	libtool --mode=install $(INSTALL) -m 0755 liblmdbg.la $(DESTDIR)$(libdir)
	$(INSTALL) -m 0755 lmdbg-run   $(DESTDIR)$(bindir)
	$(INSTALL) -m 0755 lmdbg-sym   $(DESTDIR)$(bindir)
	$(INSTALL) -m 0755 lmdbg-check $(DESTDIR)$(bindir)
	$(INSTALL) -m 0755 lmdbg-leak-check $(DESTDIR)$(bindir)

.PHONY: uninstall
uninstall :
	rm -f $(DESTDIR)$(bindir)/lmdbg-sym
	rm -f $(DESTDIR)$(bindir)/lmdbg-run
	rm -f $(DESTDIR)$(bindir)/lmdbg-check
	rm -f $(DESTDIR)$(bindir)/lmdbg-leak-check
	rm -f $(DESTDIR)$(libdir)/liblmdbg.la

.PHONY: clean
clean :
	rm -f *.a *.o *.os *.so *.lo *.la *.exe
	rm -rf .libs

.PHONY: distclean
distclean : clean
	rm -f  lmdbg-run lmdbg-check lmdbg-sym lmdbg-leak-check
	rm -f config.h config.cache config.status config.log
	rm -f Makefile
	rm -rf autom4te.cache

.PHONY: cvsclean
cvsclean : distclean
	rm -f configure config.h.in ChangeLog

###########################
VERSION=	@LMDBG_VERSION@

PROJECTNAME=	lmdbg

BIRTHDATE=	2008-04-28

###########################

.PHONY: test
test: liblmdbg.la lmdbg-sym lmdbg-check lmdbg-run
	@echo 'running tests...'; \
	OBJDIR=.. SRCDIR=.. CC=${CC}; \
	export OBJDIR SRCDIR CC; \
	if ( cd ./tests; ./test.sh > ../_test.res; \
	    diff -u test.out ../_test.res > ../_test2.res; \
	    grep -Ev '^[-+] ([?][?]:NNN|0xF00DBEAF)$$' \
		../_test2.res > ../_test3.res; \
	    grep '^[-+] ' ../_test3.res > /dev/null; \
	    ); \
	then \
	    echo '   failed'; \
	    grep -Ev '^[-+] ([?][?]:NNN|0xF00DBEAF)$$' ./_test2.res; \
	    false; \
	else \
	    echo '   succeeded'; \
	fi
