#!/bin/sh

LC_ALL=C
export LC_ALL

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
libdir=@libdir@
sysconfdir=@sysconfdir@

if test -z "$LMDBG_SOEXT"; then
    LMDBG_SOEXT=so
fi
if test -z $LMDBG_LIBDYN; then
    LMDBG_LIBDYN=$libdir/liblmdbg.so
fi

usage (){
    echo -n "\
lmdbg-sym analyses lmdbg-run's output and converts
function addresses to source code position.
Set LMDBG_LIBDYN environment variable to liblmdbg.so
The default is $libdir/liblmdbg.so.

usage:
    lmdbg-sym [OPTIONS] <prog> [files...]
OPTIONS:
    -h --help        displays this screen
    -V --version     display version
       --with-gdb    use 'gdb'. By default 'addr2line' is used.
       --with-so <filename> <flags>
                     dlopen(3) specified libraries qwith specified flags.
                     Possible flags are: RTLD_LAZY, RTLD_NOW and RTLD_GLOBAL
"
}

version (){
cat <<EOF
lmdbg-sym-@LMDBG_VERSION@
EOF
}

additional_libs=

while [ $# -ne 0 ]; do
    case $1 in
	-h)
	    usage
	    exit 0;;
	--help)
	    usage
	    exit 0;;
	-V)
	    version
	    exit 0;;
	--version)
	    version
	    exit 0;;
	--with-gdb)
	    with_gdb=1;;
        --with-so)
	    additional_libs="${additional_libs},$2:$3"
	    shift
	    shift;;
	--)
	    shift
	    break;;
	-*)
	    echo "unknown option '$1'" 1>&2
	    exit 1;;
	*)
	    break;;
    esac

    shift
done

#echo "additional_libs=$additional_libs" 1>&2

if test $# -lt 1; then
    echo "Run lmdbg-sym --help for help"
    exit 1
fi

prog=$1
shift

trap 'rm -f $tmp_file $tmp_file1 $tmp_file2' 0 1 2 3 15

if test $# -ne 1; then
    tmp_file=`mktemp /tmp/lmdbg-sym.XXXXXX`
    test $? || exit 1

    cat "$@" > "$tmp_file"
else
    tmp_file=$1
fi

tmp_file1=`mktemp /tmp/lmdbg-sym.XXXXXX`
test $? || exit 2

tmp_file2=`mktemp /tmp/lmdbg-sym.XXXXXX`
test $? || exit 3

#echo "$tmp_file1:$tmp_file2:$tmp_file with_gdb=$with_gdb" 1>&2

gawk --posix '
NF == 1 {
    hash [$1] = ""
}
END {
    for (addr in hash){
	print addr
    }
}' "$tmp_file" > "$tmp_file1"

if test "_$with_gdb" = "_1"; then
    {
	echo 'set width 0'
	echo 'break _init'
	echo 'set print demangle on'
	echo "set environment LD_PRELOAD=$LMDBG_LIBDYN"
	if test "$additional_libs"; then
	    echo "set environment LMDBG_ADD_LIBS=$additional_libs"
	fi
	echo 'r'
#	echo 'p lmdbg_dlopen_add_libs()'
	echo 'p/x 0x22552255'
	sed 's/^/b */' < "$tmp_file1"
    } | #tee log2 |
    gdb -nx -q -batch -x /dev/stdin "$prog" | #tee log |
    gawk --posix '
    flag == 1 {
	for (i=1; i <= NF; ++i){
	    if ($i == "file"){
		gsub(/[,.]$/, "", $(i+1))
		printf "%s:", $(i+1)
	    }
	    if ($i == "line"){
		gsub(/[,.]$/, "", $(i+1))
		printf "%s ", $(i+1)
	    }
	}

	printf "\n"
    }
    /22552255/ {
	flag=1
	next
    }'
else
    xargs addr2line -e "$prog" < "$tmp_file1"
fi > $tmp_file2

gawk --posix -v tmp1=$tmp_file1 -v tmp2=$tmp_file2 '
BEGIN {
    while (0 < getline addr < tmp1 && 0 < getline src < tmp2){
#	print addr " --> " "`" src "`"
	if (src != ""){
	    h [addr] = src
#	    print addr, h [addr]
	}
    }
}
NF == 1 && $1 ~ /^0x[0-9a-fA-Z]+$/ {
    if ($1 in h){
	print " " h [$1]
    }else{
	print " " $1
    }

    next
}
{
    print $0
}' < "$tmp_file"
